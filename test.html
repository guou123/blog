<html>
<head>
    <meta charset="UTF-8"/>
    <title>访问统计</title>
    <script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="http://code.highcharts.com/highcharts.js"></script>
    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</head>
<body>
    <!-- 不蒜子数据容器（隐藏） -->
    <div style="display: none;">
        <span id="busuanzi_value_site_uv"></span>
        <span id="busuanzi_value_site_pv"></span>
    </div>

    <div id="container" style="width: 550px; height: 400px; margin: 0 auto"></div>

<script>
$(document).ready(function() {
    // 初始化空图表
    var chart = Highcharts.chart('container', {
        chart: { type: 'bar' },
        title: { text: 'guou123.github.io' },
        subtitle: { text: '实时访客统计' },
        xAxis: {
            categories: ['访问人数', '访问次数'],
            title: { text: null }
        },
        yAxis: {
            min: 0,
            title: { text: 'END', align: 'high' },
            labels: { overflow: 'justify' }
        },
        tooltip: { valueSuffix: '次/人' },
        plotOptions: {
            bar: { dataLabels: { enabled: true } }
        },
        legend: {
            layout: 'vertical',
            align: 'right',
            verticalAlign: 'top',
            x: -40,
            y: 100,
            floating: true,
            borderWidth: 1,
            backgroundColor: '#FFFFFF',
            shadow: true
        },
        credits: { enabled: false },
        series: [{
            name: '用户数据',
            data: [0, 0] // 初始为0
        }]
    });

    // 监控不蒜子数据变化
    function observeBusuanzi() {
        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                if (mutation.type === 'characterData' || mutation.type === 'childList') {
                    updateChartData();
                }
            });
        });

        // 监控两个统计元素
        observer.observe(document.getElementById('busuanzi_value_site_uv'), {
            characterData: true,
            subtree: true
        });
        observer.observe(document.getElementById('busuanzi_value_site_pv'), {
            characterData: true,
            subtree: true
        });
    }

    // 更新图表数据
    function updateChartData() {
        const uv = parseInt($('#busuanzi_value_site_uv').text()) || 0;
        const pv = parseInt($('#busuanzi_value_site_pv').text()) || 0;
        
        chart.series[0].setData([uv, pv], true); // 第二个参数触发重绘动画
        chart.update({ subtitle: { text: `最后更新: ${new Date().toLocaleTimeString()}` }});
    }

    // 初始化数据获取
    function initData() {
        // 如果10秒内未加载成功显示默认值
        setTimeout(() => {
            if (chart.series[0].data[0].y === 0) {
                chart.series[0].setData([NaN, NaN]);
                chart.update({ subtitle: { text: '数据加载超时' }});
            }
        }, 10000);

        // 开始监控
        observeBusuanzi();
    }

    // 等待不蒜子脚本加载
    if (typeof busuanzi === 'undefined') {
        window.onload = initData;
    } else {
        initData();
    }
});
</script>
</body>
</html>
